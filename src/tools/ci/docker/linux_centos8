FROM centos:centos8
# Fix the repos
RUN \
  sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-* && \
  sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-* && \
  yum -y install wget && \
  wget 'http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/Packages/centos-gpg-keys-8-3.el8.noarch.rpm' && \
  rpm -i 'centos-gpg-keys-8-3.el8.noarch.rpm' && \
  dnf -y --disablerepo '*' --enablerepo=extras swap centos-linux-repos centos-stream-repos && \
  dnf -y distro-sync
# Enable powertools and EPEL repository
RUN \
  yum -y install dnf-plugins-core && \
  yum config-manager --set-enabled powertools && \
  yum -y install epel-release
RUN \
  yum -y update && \
  yum -y install \
  git \
  meson \
  perl \
  perl-IPC-Run \
  \
  bison \
  ccache \
  clang \
  flex \
  gcc \
  lz4 \
  \
  libicu-devel \
  libuuid-devel \
  libxml2-devel \
  libxslt-devel \
  llvm-devel \
  lz4-devel \
  pam-devel \
  python3-devel \
  readline-devel \
  systemd-devel \
  tcl-devel \
  \
  openldap-devel \
  openldap-clients \
  openldap-servers \
  \
  openssl \
  openssl-devel \
  \
  krb5-devel \
  krb5-server \
  krb5-server-ldap \
  krb5-workstation && \
  pip3 install ninja
# Meson tries to run typemap from /usr/share/perl5/vendor_perl/ExtUtils/typemap but typemap is
# at /usr/share/perl5/ExtUtils/typemap path
RUN \
  find /usr/share/perl5/ExtUtils -name typemap -exec ln -sf '{}' /usr/share/perl5/vendor_perl/ExtUtils/typemap ';'
ENV LANG=en_US.UTF-8
